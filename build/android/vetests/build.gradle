apply plugin: 'com.android.model.application'
def ndkDir = System.getenv("ANDROID_NDK_HOME")
def propertiesFile = project.rootProject.file('local.properties')
if (propertiesFile.exists()) {
    Properties properties = new Properties()
    properties.load(propertiesFile.newDataInputStream())
    ndkDir = properties.getProperty('ndk.dir')
}
model {
    repositories {
        libs(PrebuiltLibraries) {
            voidengine {
                // Inform Android Studio where header file dir for this lib
                headers.srcDir "../../../Engine"
                // Inform Android Studio where lib is -- each ABI should have a lib file
                binaries.withType(SharedLibraryBinary) {
                    sharedLibraryFile = file("../voidengine/libs/${targetPlatform.getName()}/libvoidengine.so")
                }
            }
        }
    }

    android {
        compileSdkVersion = 25
        buildToolsVersion = "25.0.0"

        defaultConfig.with {
            applicationId = "com.voidengine.vetests"
            minSdkVersion.apiLevel = 18
            targetSdkVersion.apiLevel = 23
            versionCode = 1
            versionName = "1.0"
            //multiDexEnabled = true
        }

    }

    android.sources {
        main {
            jni {
                source {
                    srcDirs = ["../../../Tests"]
                }

                dependencies {
                    library 'voidengine' linkage 'shared'
                }
            }

            jniLibs {
                source {
                    srcDir "../voidengine/libs"
                }
            }
            assets {
                source {
                    srcDirs = ["../../../resources"]
                }
            }
        }
    }

//    compileOptions.with {
//        sourceCompatibility = JavaVersion.VERSION_1_7
//        targetCompatibility = JavaVersion.VERSION_1_7
//    }

    android.ndk {
        moduleName = "vetests"
//        CFlags.add("-I${file("../../../Engine")}".toString())
//        CFlags.add("-I${ndkDir}/sources/android/native_app_glue".toString())
        cppFlags.add("-I${file("../../../Engine")}".toString())
//        //cppFlags += "-I${file("../../../Engine/BaseCore")}".toString()
//        //cppFlags += "-I${file("../../../Engine/Debuger")}".toString()
//        //cppFlags += "-I${file("../../../Engine/FileCore")}".toString()
//        //cppFlags += "-I${file("../../../Engine/KernelCore")}".toString()
//        cppFlags.add("-I${ndkDir}/sources/android/native_app_glue".toString())
        cppFlags.add("-I${file("../../../Dependents")}".toString())
        cppFlags.add("-I${file("../../../Dependents/freetype/include")}".toString())
//        cppFlags.add("-I${file("../../../Dependents/gli")}".toString())
//        cppFlags.add("-I${file("../../../Dependents/glm")}".toString())
        cppFlags.add("-Werror")
        cppFlags.add("-frtti")
        cppFlags.add("-fno-exceptions")
        cppFlags.add("-DANDROID")
        cppFlags.add("-std=c++11")
        ldLibs.addAll(["log", "GLESv3", "EGL", "android"])
        abiFilters.addAll(['armeabi', 'armeabi-v7a'])
        stl = "gnustl_static"
    }

    android.buildTypes {
        release {
            minifyEnabled = false
            proguardFiles.add(file('proguard-android.txt'))
        }
    }

//    android.productFlavors {
//        create("arm7") {
//            ndk.abiFilters += "armeabi-v7a"
////            ndk.ldFlags += "${file("../../../Dependents/libpng/lib/android/armeabi-v7a/libpng.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/freetype/lib/android/armeabi-v7a/libfreetype.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/libjpeg/lib/android/armeabi-v7a/libjpeg.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/openexr/lib/android/armeabi-v7a/libopenexr.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/zlib/lib/android/armeabi-v7a/libz.a")}".toString()
//        }
//        create("arm8") {
//            ndk.abiFilters += "arm64-v8a"
////            ndk.ldFlags += "${file("../../../Dependents/libpng/lib/android/arm64-v8a/libpng.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/freetype/lib/android/arm64-v8a/libfreetype.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/libjpeg/lib/android/arm64-v8a/libjpeg.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/openexr/lib/android/arm64-v8a/libopenexr.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/zlib/lib/android/arm64-v8a/libz.a")}".toString()
//        }
//        create("x86-64") {
//            ndk.abiFilters += "x86_64"
////            ndk.ldFlags += "${file("../../../Dependents/libpng/lib/android/x86_64/libpng.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/freetype/lib/android/x86_64/libfreetype.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/libjpeg/lib/android/x86_64/libjpeg.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/openexr/lib/android/x86_64/libopenexr.a")}".toString()
////            ndk.ldFlags += "${file("../../../Dependents/zlib/lib/android/x86_64/libz.a")}".toString()
//        }
//        // for detailed abiFilter descriptions, refer to "Supported ABIs" @
//        // https://developer.android.com/ndk/guides/abis.html#sa
//
//        // build one including all cpu architectures
//        // create("all")
//    }
}
//dependencies {
//    println rootProject.getName()
//    compile fileTree(dir: 'libs', include: ['*.jar'])
//    compile 'com.android.support:appcompat-v7:23.3.0'
//}

tasks.whenTaskAdded { task ->
    if (task.name.contains('compile')) {
        task.dependsOn ':voidengine:distributeLib'
    }
}
dependencies {
    compile project(':voidengine')
}